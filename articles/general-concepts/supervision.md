# 监督和监控
本章概述了监督（`supervision`）背后的概念、提供的原语及其语义。有关如何转换为真实代码的详细信息，，请参阅[监督](../typed/fault-tolerance.md)。

监督自经典以来发生了变化，有关经典监督的详细信息请参见[经典监督](https://doc.akka.io/docs/akka/current/supervision-classic.html)

## 监督是什么意思

有两类异常可能发生在 actor 中：

1. 输入验证错误，可以使用常规 try-catch 或其他语言和标准库工具处理的预期异常。
2. 意外**故障**，例如网络资源不可用、磁盘写入失败或应用程序逻辑中的错误。

监督处理失败，应该与业务逻辑分离，而验证数据和处理预期异常是业务逻辑的重要组成部分。因此，监督是作为装饰添加到actor 的，而不是与actor 的消息处理逻辑混合的东西。

根据要监督的工作性质和失败的性质，监督提供以下三种策略：

1. 恢复actor，保持其累积的内部状态
2. 重新启动actor，清除其累积的内部状态，再次启动潜在的延迟
3. 永久停止actor

由于actor 是层次结构的一部分，因此向上传播永久故障通常是有意义的，如果actor 的所有孩子都意外停止，则actor 本身重新启动或停止以恢复到功能状态可能是有意义的。这可以通过监督和观察孩子在他们终止时得到通知相结合来实现。这方面的一个例子可以[失败在整个层次结构中冒泡](../typed/fault-tolerance.md#失败在整个层次结构中冒泡)找到。

## 顶级监督者
一个actor系统在其创建过程中将至少启动两个actor。 

### `/user`: 用户监护人 actor

这是顶级用户提供的 actor，旨在通过将子系统生成为子项来引导应用程序。当用户监护人停止时，整个actor系统就会关闭。

### `/system`: 系统监护人actor

引入这个特殊的监护人是为了实现有序的关闭序列，其中日志记录保持活动状态，直到所有正常的 actor 终止，即使日志记录本身也是使用 actor 实现的。这实际上是让系统监护人监视用户监护人并在看到用户监护人停止后才开始关闭自己。

## 重启意味着什么？
重启出现在当一个 Actor 处理特定消息失败时，失败的原因分为三类：

- 接收到特定的系统性（即编程）错误消息
- 处理消息过程中使用的某些外部资源出现故障
- Actor 的内部状态已损坏

除非故障被具体识别，否则不能排除第三种原因，从而得出需要清除内部状态的结论。如果监督者认为它的其他孩子或它自己不受损坏的影响——例如因为有意识地应用了错误内核模式——因此最好重新启动actor。这是通过创建基础`Behavior`类的新实例并用子类中的新实例替换失败的实例来实现的`ActorRef`；能够做到这一点也是将 actor 封装在特殊引用中的原因之一。然后新的actor继续处理它的邮箱，这意味着重启在actor本身之外是不可见的，值得注意的例外是发生故障的消息不会被重新处理。

## 生命周期监控意味着什么？
- **注释**：Akka 中的生命周期监控通常被称为`DeathWatch`。

与上面描述的父母和子女之间的特殊关系不同，每个 Actor 可以监视（`monitor`）任何其他 Actor。由于actor从创建中完全存活并且重启在受影响的监督者之外是不可见的，因此可用于监控的唯一状态更改是从活跃到死亡的过渡。因此，监控（`Monitoring`）被用来将一个 Actor 与另一个 Actor 联系起来，这样它就可以对另一个 Actor 的终止做出反应，这与对失败做出反应的监督形成对比。

生命周期监控是让监控 Actor 接收到`Terminated`消息来实现的，在该消息中，默认行为是如果不进行其他处理，则抛出一个特殊的`DeathPactException`。为了开始监听`Terminated`消息，需要调用`ActorContext.watch(targetActorRef)`。若要停止监听，则需要调用`ActorContext.unwatch(targetActorRef)`。一个重要的属性是，不管监控请求和目标终止的顺序如何，消息都将被传递，即使在注册时目标已经死了，你仍然会收到消息。

## Actor和exceptions

当一个消息正在被一个actor 处理时，可能会发生某种异常被抛出，例如一个数据库异常。

### 消息如何处理

如果在处理消息时抛出异常（即从其邮箱中取出并移交给当前行为），则该消息将丢失。重要的是要了解它不会放回邮箱。因此，如果您想重试处理消息，则需要通过捕获异常并重试流程来自己处理。确保限制重试次数，因为您不希望系统活锁（因此消耗大量 CPU 周期而没有取得进展）。

### 邮箱如何反应

如果在处理消息时抛出异常，则邮箱不会发生任何变化。如果 actor 重新启动，相同的邮箱将在那里。因此，该邮箱上的所有邮件也将在那里。

### actor如何反应

如果actor 中的代码抛出异常，则该actor 将被挂起并启动监督过程。根据主管的决定，actor 被恢复（好像什么也没发生）、重新启动（清除其内部状态并从头开始）或终止。

----------

[Actor references、路径和地址](addressing.md)

----------
**英文原文链接**：[Supervision and Monitoring](https://doc.akka.io/docs/akka/current/general/supervision.html).